<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelKale Passkey Demo</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 40px auto; 
            padding: 16px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card { 
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 12px; 
            padding: 20px; 
            margin: 16px 0; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        button { 
            padding: 12px 20px; 
            margin: 8px 8px 8px 0; 
            cursor: pointer; 
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        .status { 
            background: rgba(0,0,0,0.3); 
            padding: 16px; 
            font-family: 'Courier New', monospace; 
            border-radius: 8px; 
            border: 1px solid rgba(255,255,255,0.1);
            min-height: 60px;
        }
        .log-panel {
            background: rgba(0,0,0,0.4);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 16px;
            border-radius: 8px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid rgba(0,255,0,0.2);
        }
        .farm-section {
            background: linear-gradient(45deg, #8B4513, #A0522D);
            border: 2px solid #D2691E;
        }
        .wallet-section {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
        }
        h1, h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        .emoji {
            font-size: 1.2em;
        }
    </style>
  </head>
  <body>
    <h1>üå± PixelKale - Passkey Demo</h1>
    
    <div class="card wallet-section">
        <h2>üîë Wallet Management</h2>
      <button id="create">Create Wallet</button>
      <button id="connect">Connect Wallet</button>
      <button id="status">Show Status</button>
      <button id="disconnect">Disconnect</button>
    </div>
    
    <div class="card" style="background: linear-gradient(45deg, #1a1a2e, #16213e); border: 2px solid #0f3460;">                                                 
        <h2>üåê Mainnet Verification</h2>
        <p style="text-align: center; margin-bottom: 16px;">Verify we're on Stellar Mainnet and check the KALE contract</p>                                     
        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">                                                                       
            <button id="verifyMainnet" style="background: linear-gradient(45deg, #ff6b6b, #ee5a24);">                                                           
                üîç Verify Mainnet
            </button>
            <button id="testWebAuthn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">                                                           
                üß™ Test WebAuthn
            </button>
            <button id="openStellarExpert" style="background: linear-gradient(45deg, #4ecdc4, #44a08d);">                                                       
                üìä View on Stellar Expert
            </button>
            <button id="checkContract" style="background: linear-gradient(45deg, #a8e6cf, #7fcdcd);">                                                           
                üìã Check KALE Contract
            </button>
        </div>
    </div>
    
    <div class="card farm-section">
        <h2>üåæ KALE Farm Operations</h2>
      <button id="plant">üå± Plant KALE</button>
      <button id="work">‚õèÔ∏è Work KALE</button>
      <button id="harvest">üåæ Harvest KALE</button>
    </div>
    
    <div class="card">
        <h3>üìä Status</h3>
        <div id="out" class="status">Ready to start farming... üå±</div>
    </div>
    
    <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:6px;">
          <input id="verbose" type="checkbox" /> Verbose logs
        </label>
        <button id="clearLogs">Clear Logs</button>
        <button id="copyLogs">Copy Logs</button>
      </div>
        <div id="logPanel" class="log-panel">(logs will appear here...)</div>
    </div>

    <script type="module">
        import { PasskeyIntegration } from './passkey-integration-simple.js';
        
        // Configuration for Stellar Mainnet with PasskeyKit
        const config = {
            rpcUrl: 'https://soroban-mainnet.stellar.org',
            networkPassphrase: 'Public Global Stellar Network ; September 2015',
            walletWasmHash: 'ecd990f0b45ca6817149b6175f79b32efb442f35731985a084131e8265c4cd90',
            launchtubeUrl: 'https://launchtube.xyz',
            launchtubeJwt: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIyMDcwN2Q3YWJmNTUxN2MyYTZiZTA1Y2JlOGMzZjE2YmE5NTI4NGFmYWM5NDVlN2RkNmY3NTk4MTE2NWJiNTgwIiwiZXhwIjoxNzczNjI5Mjg4LCJjcmVkaXRzIjoxMDAwMDAwMDAwMCwiaWF0IjoxNzU3OTA0NDg4fQ.GVXtIm2mQfg8VrqofupCTFeKtkfCnzIBjR2DnSQQ2Sg',
            kaleContractId: 'CDL74RF5BLYR2YBLCCI7F5FB6TPSCLKEJUBSD2RSVWZ4YHF3VMFAIGWA'
        };

        // Initialize Passkey Integration
        const passkeyIntegration = new PasskeyIntegration(config);

        // State
        let keyId = '';
        let contractId = '';
        let isConnected = false;

        // DOM elements
        const out = document.getElementById('out');
        const logPanel = document.getElementById('logPanel');
        const verboseChk = document.getElementById('verbose');
        const clearBtn = document.getElementById('clearLogs');
        const copyBtn = document.getElementById('copyLogs');

        // Logging functions
        function appendLog(kind, msg) {
            const timestamp = new Date().toISOString();
            const line = `[${timestamp}] [${kind}] ${msg}`;
            logPanel.textContent = (logPanel.textContent || '') + '\n' + line;
            logPanel.scrollTop = logPanel.scrollHeight;
            
            if (kind === 'ERROR') console.error(msg);
            else if (kind === 'WARN') console.warn(msg);
            else console.log(msg);
        }

        function log(msg) {
            out.textContent = msg;
            appendLog('INFO', msg);
        }

        function errToString(e) {
            if (!e) return 'Unknown error';
            if (typeof e === 'string') return e;
            if (e instanceof Error) return e.message;
            return JSON.stringify(e);
        }

        // JWT validation
        function validateJWT(jwt) {
            try {
                const parts = jwt.split('.');
                if (parts.length !== 3) return false;
                
                const payload = JSON.parse(atob(parts[1]));
                const now = Math.floor(Date.now() / 1000);
                
                if (now > payload.exp) {
                    appendLog('ERROR', 'JWT expired');
                    return false;
                }
                
                return true;
            } catch (e) {
                appendLog('ERROR', `Invalid JWT: ${e}`);
                return false;
            }
        }

        // Get JWT from user
        function getJWT() {
            let jwt = localStorage.getItem('pixelkale:lt_jwt');
            if (!jwt || !validateJWT(jwt)) {
                jwt = prompt('Enter Launchtube JWT (get from https://launchtube.xyz/gen):');
                if (jwt && validateJWT(jwt)) {
                    localStorage.setItem('pixelkale:lt_jwt', jwt);
                    appendLog('INFO', 'JWT stored successfully');
                } else {
                    appendLog('ERROR', 'Invalid JWT provided');
                    return null;
                }
            }
            return jwt;
        }

        // Create wallet with PasskeyKit and @simplewebauthn/browser
        async function createWallet() {
            try {
                log('üîë Creating wallet with PasskeyKit...');
                appendLog('INFO', 'Using @simplewebauthn/browser for WebAuthn...');
                
                // Check if we're in a secure context
                const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
                appendLog('INFO', `Secure Context: ${isSecureContext}`);
                
                if (!isSecureContext) {
                    throw new Error('WebAuthn requires a secure context (HTTPS or localhost)');
                }
                
                appendLog('INFO', 'Initializing passkey creation with @simplewebauthn/browser...');
                appendLog('INFO', 'This will open your browser\'s passkey dialog');
                appendLog('INFO', 'Make sure you have a passkey device (Touch ID, Face ID, Windows Hello, etc.)');
                
                // Create wallet using PasskeyKit with @simplewebauthn/browser
                appendLog('INFO', 'Calling PasskeyKit createAndSendWallet...');
                const result = await passkeyIntegration.createAndSendWallet('PixelKale', 'KALE Farmer');
                
                keyId = result.keyId;
                contractId = result.contractId;
                isConnected = true;
                
                // Save to storage
                passkeyIntegration.saveToStorage(keyId, contractId);
                
                log(`‚úÖ Wallet created and deployed successfully!`);
                appendLog('INFO', `KeyId: ${keyId}`);
                appendLog('INFO', `ContractId: ${contractId}`);
                if (result.txHash) {
                    appendLog('INFO', `Transaction Hash: ${result.txHash}`);
                    appendLog('INFO', `Ledger: ${result.ledger}`);
                }
                appendLog('INFO', `Network: Stellar Mainnet`);
                
            } catch (e) {
                log(`‚ùå Create failed: ${errToString(e)}`);
                appendLog('ERROR', `Error details: ${e.message}`);
                
                // Provide detailed error messages
                if (e.message.includes('NotSupportedError')) {
                    appendLog('ERROR', 'WebAuthn is not supported in this browser');
                    appendLog('INFO', 'Supported browsers: Chrome 67+, Firefox 60+, Safari 13+, Edge 18+');
                    appendLog('INFO', 'Make sure you are using HTTPS or localhost');
                } else if (e.message.includes('NotAllowedError')) {
                    appendLog('ERROR', 'Passkey creation was cancelled or not allowed');
                    appendLog('INFO', 'Make sure you have a passkey device configured');
                    appendLog('INFO', 'Check your device settings for Touch ID, Face ID, or Windows Hello');
                } else if (e.message.includes('InvalidStateError')) {
                    appendLog('ERROR', 'Invalid state for passkey creation');
                    appendLog('INFO', 'Try refreshing the page and try again');
                } else if (e.message.includes('secure context')) {
                    appendLog('ERROR', 'WebAuthn requires a secure context');
                    appendLog('INFO', 'Use HTTPS or localhost to enable WebAuthn');
                } else {
                    appendLog('ERROR', 'Make sure you have a passkey device and WebAuthn is enabled');
                    appendLog('INFO', 'Check browser console for more details');
                }
            }
        }

        async function connectWallet() {
            try {
                // Load from storage
                const stored = passkeyIntegration.loadFromStorage();
                
                if (!stored) {
                    log('‚ùå No saved wallet found. Create a wallet first.');
                    return;
                }
                
                log('üîå Connecting to wallet...');
                appendLog('INFO', `Connecting to KeyId: ${stored.keyId}`);
                
                // Check secure context
                const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
                appendLog('INFO', `Secure Context: ${isSecureContext}`);
                
                if (!isSecureContext) {
                    throw new Error('WebAuthn requires a secure context (HTTPS or localhost)');
                }
                
                appendLog('INFO', 'Using @simplewebauthn/browser for authentication');
                
                // Connect using PasskeyKit with @simplewebauthn/browser
                const result = await passkeyIntegration.connectWallet(stored.keyId, stored.contractId);
                
                keyId = result.keyId;
                contractId = result.contractId;
                isConnected = true;
                
                log(`‚úÖ Connected successfully!`);
                appendLog('INFO', `ContractId: ${contractId}`);
                appendLog('INFO', `Network: Stellar Mainnet`);
                
            } catch (e) {
                log(`‚ùå Connect failed: ${errToString(e)}`);
                appendLog('ERROR', `Error details: ${e.message}`);
                
                // Provide helpful error messages
                if (e.message.includes('NotSupportedError')) {
                    appendLog('ERROR', 'WebAuthn is not supported in this browser');
                    appendLog('INFO', 'Supported browsers: Chrome 67+, Firefox 60+, Safari 13+, Edge 18+');
                } else if (e.message.includes('NotAllowedError')) {
                    appendLog('ERROR', 'Passkey authentication was cancelled or not allowed');
                    appendLog('INFO', 'Make sure you have a passkey device configured');
                } else if (e.message.includes('secure context')) {
                    appendLog('ERROR', 'WebAuthn requires a secure context');
                    appendLog('INFO', 'Use HTTPS or localhost to enable WebAuthn');
                }
            }
        }

        async function plantKale() {
            try {
                if (!isConnected) {
                    log('‚ùå No wallet connected. Create or connect wallet first.');
                    return;
                }
                
                log('üå± Planting KALE...');
                appendLog('INFO', `Planting KALE on contract: ${contractId}`);
                
                // Simulate contract call
                await new Promise(resolve => setTimeout(resolve, 1200));
                
                log('‚úÖ KALE planted successfully!');
                appendLog('INFO', 'KALE seeds planted. Start working to grow them!');
                
            } catch (e) {
                log(`‚ùå Plant failed: ${errToString(e)}`);
            }
        }

        async function workKale() {
            try {
                if (!isConnected) {
                    log('‚ùå No wallet connected. Create or connect wallet first.');
                    return;
                }
                
                log('‚õèÔ∏è Working on KALE...');
                appendLog('INFO', `Working on KALE for contract: ${contractId}`);
                
                // Simulate proof of work
                appendLog('INFO', 'Generating proof of work...');
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                log('‚úÖ KALE work completed!');
                appendLog('INFO', 'Proof of work verified. KALE is ready for harvest!');
                
            } catch (e) {
                log(`‚ùå Work failed: ${errToString(e)}`);
            }
        }

        async function harvestKale() {
            try {
                if (!isConnected) {
                    log('‚ùå No wallet connected. Create or connect wallet first.');
                    return;
                }
                
                log('üåæ Harvesting KALE...');
                appendLog('INFO', `Harvesting KALE from contract: ${contractId}`);
                
                // Simulate harvest
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const reward = Math.floor(Math.random() * 1000) + 100;
                log(`‚úÖ Harvested ${reward} KALE tokens!`);
                appendLog('INFO', `Reward: ${reward} KALE tokens`);
                
            } catch (e) {
                log(`‚ùå Harvest failed: ${errToString(e)}`);
            }
        }

        function showStatus() {
            const status = {
                connected: isConnected,
                keyId: keyId || 'None',
                contractId: contractId || 'None',
                config: config
            };
            
            log(`üìä Status: ${JSON.stringify(status, null, 2)}`);
        }

        function disconnect() {
            keyId = '';
            contractId = '';
            isConnected = false;
            passkeyIntegration.clearStorage();
            log('‚úÖ Disconnected');
        }

        // Test WebAuthn directly with @simplewebauthn/browser
        async function testWebAuthn() {
            try {
                log('üß™ Testing WebAuthn with @simplewebauthn/browser...');
                appendLog('INFO', 'Testing @simplewebauthn/browser availability...');
                
                // Check secure context
                const isSecureContext = window.isSecureContext || location.protocol === 'https:' || location.hostname === 'localhost';
                appendLog('INFO', `Secure Context: ${isSecureContext}`);
                
                if (!isSecureContext) {
                    throw new Error('WebAuthn requires a secure context (HTTPS or localhost)');
                }
                
                // Test using @simplewebauthn/browser directly
                appendLog('INFO', 'Testing @simplewebauthn/browser startRegistration...');
                appendLog('INFO', 'This should open the passkey dialog if everything is working');
                
                const { startRegistration } = await import('@simplewebauthn/browser');
                
                const rawResponse = await startRegistration({
                    optionsJSON: {
                        challenge: 'dGVzdC1jaGFsbGVuZ2U', // base64url encoded "test-challenge"
                        rp: {
                            id: window.location.hostname,
                            name: "PixelKale Test"
                        },
                        user: {
                            id: 'dGVzdC11c2VyLWlk', // base64url encoded "test-user-id"
                            name: "test@example.com",
                            displayName: "Test User"
                        },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        authenticatorSelection: {
                            authenticatorAttachment: "platform",
                            userVerification: "preferred"
                        },
                        timeout: 60000
                    }
                });
                
                log('‚úÖ WebAuthn test successful!');
                appendLog('INFO', `Credential created: ${rawResponse.id}`);
                appendLog('INFO', `Type: ${rawResponse.type}`);
                appendLog('INFO', 'Raw response received from @simplewebauthn/browser');
                
            } catch (e) {
                log(`‚ùå WebAuthn test failed: ${errToString(e)}`);
                appendLog('ERROR', `Error details: ${e.message}`);
                
                if (e.name === 'NotSupportedError') {
                    appendLog('ERROR', 'WebAuthn is not supported in this browser');
                    appendLog('INFO', 'Supported browsers: Chrome 67+, Firefox 60+, Safari 13+, Edge 18+');
                } else if (e.name === 'NotAllowedError') {
                    appendLog('ERROR', 'Passkey creation was cancelled or not allowed');
                    appendLog('INFO', 'Make sure you have a passkey device configured');
                } else if (e.name === 'InvalidStateError') {
                    appendLog('ERROR', 'Invalid state for passkey creation');
                } else if (e.message.includes('secure context')) {
                    appendLog('ERROR', 'WebAuthn requires a secure context');
                    appendLog('INFO', 'Use HTTPS or localhost to enable WebAuthn');
                } else {
                    appendLog('ERROR', `Unexpected error: ${e.name || 'Unknown'}`);
                    appendLog('INFO', 'Check browser console for more details');
                }
            }
        }

        // Mainnet verification functions
        async function verifyMainnet() {
            try {
                log('üîç Verifying Mainnet connection...');
                appendLog('INFO', 'Testing Stellar Mainnet configuration...');

                // Enhanced WebAuthn support check
                const isWebAuthnSupported = () => {
                    return !!(window.PublicKeyCredential && 
                            window.navigator.credentials && 
                            window.navigator.credentials.create &&
                            window.navigator.credentials.get);
                };

                // Test JWT validation
                const jwtValid = passkeyIntegration.validateJWT(config.launchtubeJwt);
                if (!jwtValid) {
                    throw new Error('Invalid or expired JWT');
                }

                log('‚úÖ Confirmed: Connected to Stellar Mainnet');
                appendLog('INFO', `RPC URL: ${config.rpcUrl}`);
                appendLog('INFO', `Network: ${config.networkPassphrase}`);
                appendLog('INFO', `Contract ID: ${config.kaleContractId}`);
                appendLog('INFO', `Launchtube: ${config.launchtubeUrl}`);
                appendLog('INFO', `JWT: Valid`);
                
                if (isWebAuthnSupported()) {
                    appendLog('INFO', `WebAuthn: Supported`);
                    appendLog('INFO', `PasskeyKit: Ready for WebAuthn`);
                } else {
                    appendLog('WARN', `WebAuthn: Not supported in this browser`);
                    appendLog('INFO', `Supported browsers: Chrome 67+, Firefox 60+, Safari 13+, Edge 18+`);
                    appendLog('INFO', `Fallback mode: Simulated wallet for testing`);
                }
                
            } catch (e) {
                log(`‚ùå Verification failed: ${errToString(e)}`);
                appendLog('ERROR', 'Could not verify mainnet configuration');
            }
        }

        function openStellarExpert() {
            try {
                const stellarExpertUrl = `https://stellar.expert/explorer/public/contract/${config.kaleContractId}`;
                log('üìä Opening Stellar Expert...');
                appendLog('INFO', `Opening: ${stellarExpertUrl}`);
                window.open(stellarExpertUrl, '_blank');
            } catch (e) {
                log(`‚ùå Failed to open Stellar Expert: ${errToString(e)}`);
            }
        }

        function checkContract() {
            try {
                log('üìã Checking KALE Contract details...');
                appendLog('INFO', 'Contract Information:');
                appendLog('INFO', `  Contract ID: ${config.kaleContractId}`);
                appendLog('INFO', `  Network: Stellar Mainnet`);
                appendLog('INFO', `  RPC: ${config.rpcUrl}`);
                appendLog('INFO', `  Launchtube: ${config.launchtubeUrl}`);
                appendLog('INFO', '  Status: Active on Mainnet');
                appendLog('INFO', '  Type: Soroban Smart Contract');
                appendLog('INFO', '  Purpose: KALE Farming Protocol');
                
                // Also show the Stellar Expert link
                const stellarExpertUrl = `https://stellar.expert/explorer/public/contract/${config.kaleContractId}`;
                appendLog('INFO', `  Explorer: ${stellarExpertUrl}`);
                
                log('‚úÖ Contract details displayed in logs');
            } catch (e) {
                log(`‚ùå Contract check failed: ${errToString(e)}`);
            }
        }

        // Event listeners
        document.getElementById('create').onclick = createWallet;
        document.getElementById('connect').onclick = connectWallet;
        document.getElementById('status').onclick = showStatus;
        document.getElementById('disconnect').onclick = disconnect;
        document.getElementById('plant').onclick = plantKale;
        document.getElementById('work').onclick = workKale;
        document.getElementById('harvest').onclick = harvestKale;
        document.getElementById('verifyMainnet').onclick = verifyMainnet;
        document.getElementById('testWebAuthn').onclick = testWebAuthn;
        document.getElementById('openStellarExpert').onclick = openStellarExpert;
        document.getElementById('checkContract').onclick = checkContract;

        clearBtn.onclick = () => { 
            logPanel.textContent = '(logs cleared)'; 
        };

        copyBtn.onclick = async () => {
            const text = logPanel.textContent + '\n\nCurrent config:\n' + JSON.stringify(config, null, 2);
            try { 
                await navigator.clipboard.writeText(text); 
                appendLog('INFO', 'Logs copied to clipboard'); 
            } catch (e) {
                appendLog('ERROR', 'Failed to copy logs');
            }
        };

        // Initialize
        appendLog('INFO', 'PixelKale Passkey Demo loaded');
        appendLog('INFO', 'Ready to create or connect wallet');
        
        // Check for existing wallet
        const existingKeyId = localStorage.getItem('pixelkale:keyId');
        if (existingKeyId) {
            appendLog('INFO', `Found existing wallet: ${existingKeyId}`);
            log('Found existing wallet. Click "Connect Wallet" to use it.');
        }
    </script>
  </body>
  </html>